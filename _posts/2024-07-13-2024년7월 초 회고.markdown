---
layout: post
title:  "다른 앱간 S3 연동 문제"
date:   2024-07-23 00:00:00 +0900
categories: 
---
이미지 데이터 연동하기

제가 개발하는 서버는 A 입니다.  사내에 B라는 서버가 있습니다.

요구사항: B 서버에서 관리하고 있는 이미지를 A 서버의 플래폼에서 보여줄 수 있어야 한다.

처음에는 각자 S3 버킷을 분리해서 사용하고 있으니 B 서버로 부터 필요한 이미지 파일을 찾고 다운받아서 A서버가 관리하는 S3 버킷에 저장하고 DB에 관련한 정보를 저장하면 되겠다고 생각했다.

이 방식은 구현은 가능하지만 중복된 데이터가 저장된다는 문제가 있다. 좋은 선택지가 아니었다.

더 좋은 방법은 B 서버가 저장하고 있는 파일의 S3 경로만을 DB에 저장하는 것이다. A서버에서는 B서버의 저장된 이미지파일 경로를 바탕으로 B서버의 S3버킷으로 접속하여 해당 파일을 A서버의 사용자에게 보여줄 수 있다.

이것을 구현하기 위해서 A서버의 환경변수에 B서버S3버킷의 엑세스키와 프라이빗키를 모두 저장하려고 시도했으나 보안적인 측면에서 좋은 방식이 아니었다.

더 좋은 방법은 AWS에서 제공하는 IAM 설정을 이용하는 것인데 EC2 자체에 IAM 프로파일을 적용하여서 특정 S3버킷에 대한 요청을 허용하게끔 설정할 수 있었다. 여기서는 단순히 Get요청만 허용하면 되므로 GetObject만 허용하면 되었다.

해당 IAM 설정이 완료되면 자바 S3 SDK에서는 InstanceProfileCredentialsProvider로 민감한 엑세스키 없이 미리 설정된 S3버킷으로 파일을 요청할 수 있다.

또한 내부적으로 파일의 경로에 따라 다른 버킷을 사용해야 하므로 버킷를 구별할 수 있는 enum 등을 해당 엔티티에 저장해 두는 편이 좋았다.


//

업데이트 측면에서

일반적으로 API콜을 하면 이미지와 관련된 모든 데이터를 모두 조회시킨다. 


A서버에서는 사용자가 직접 이미지를 올리기도 한다. 그리고 삭제하고 수정하기도 한다. 그런데 해당 이미지 생애 주기에 있어서 B서버의 개입이 있다면 저장되는 이미지 정보가 A서버에서 관리된 것인지 B서버에서 관리된 것인지 확인을 해야한다.

따라서 이미지 정보에서는 관리 출처가 필요하다.

데이터를 동기화 시키는 과정에서 B서버의 이미지 데이터를 조회하게 된다. 해당 데이터의 식별자를 바탕으로 분류하여  A서버에서는 없는 경우에는 추가해야한다. 반대로 A서버에는 해당 식별자가 존재하는데 B서버에는 없는 경우가 있다. 이런 경우는 B서버에서 모종의 삭제처리가 발생했다고 간주해야하고 해당 식별자의 정보는 A서버로부터 제거해야한다.

조금 걱정이 든 것이 보통 약 1만장의 이미지의 메타 정보가 응답 바디에 저장되기 때문에 api 속도도 느릴까봐, 또는 비용이 클까봐 걱정되었다.

해당 이미지는 "시퀀스"라고 하는 묶임으로 약 40장정보가 묶이고 시퀀스는 1~5개가 하나의 "스캔"으로 묶이게 된다.

따라서 조금 최적해보자면 api를 분리해서 스캔이나 스퀀스 uid 리스트만 가져오는 api를 하나 만든다면 좀 더 경량화된 상태로 업데이트 필요 여부를 체크할 수 있으리라고 생각되었다.

여기서의 가정은 시퀀스 안에 이미지 파일이 시퀀스와 생명주기를 함께한다는 가정이고 일부 파일의 삭제가 아닌 시퀀스 단위로 삭제와 생성이 이뤄진다는 도메인 룰 하에서의 가정이다.

